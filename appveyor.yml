version: build.{build}
skip_tags: true
image: Visual Studio 2017
environment:
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PYTHON: C:\Python37-x64
  PYTHON_VERSION: 3.7
  PYTHON_ARCH: 64
  ETA_VER: v0.5.11
  GITHUB_TOKEN:
    secure: IdgCOIno/YfkZynVnR2pBSjpkNG+4+XZneFXnqBVvxwX3MYX0EKqdzIUVPxQrkJu
  PYPI_USERNAME:
    secure: +n9bRrcr1wUOt6LkYPOmBw==
  PYPI_PASSWORD:
    secure: yRdmCM7a4/Tg2xMCn38bSc9+xadPa1zVf7FCZtKCsPI=
  GOPATH: c:\gopath


init:
- cmd: >-
    SET PATH=%PYTHON%;%PYTHON%\Scripts;%PATH%
    
    echo %GOPATH%

    set PATH=%GOPATH%\bin;c:\go\bin;%PATH%
    
    echo %PATH%
    
    python --version
    
    go version

    go env

install:
- ps: >-
    python -m pip --version
    
    pip install --upgrade -r requirements.txt

    7z a ETA_LIB-win64.zip "c:\python37-x64\lib\site-packages"

    go get github.com/itchio/gothub
    
    gothub info -u timetag -r ETA

    python -m pip install twine --upgrade
    
    python -m pip install wheel --upgrade
    
    Install-Product node 8 x64

    cd gui

    yarn

    cd ..

cache:
- '%LOCALAPPDATA%\pip\Cache'
- gui\node_modules
- '%USERPROFILE%\.electron'
- '%LOCALAPPDATA%\electron\Cache'
- '%LOCALAPPDATA%\electron-builder\cache'

build_script:
- cmd: >-
    echo building wheel

    python setup.py bdist_wheel

    echo building GUI
    
    appveyor DownloadFile https://www.python.org/ftp/python/3.7.3/python-3.7.3-amd64-webinstall.exe -FileName %APPVEYOR_BUILD_FOLDER%\gui\python-webinstall.exe

    cd gui

    yarn dist

    cd ..

    ls %APPVEYOR_BUILD_FOLDER%\gui\dist\

    mkdir %APPVEYOR_BUILD_FOLDER%\install_zip\

    move %APPVEYOR_BUILD_FOLDER%\gui\dist\*.exe %APPVEYOR_BUILD_FOLDER%\install_zip\

    move %APPVEYOR_BUILD_FOLDER%\dist\*.whl %APPVEYOR_BUILD_FOLDER%\install_zip\
    
    ls %APPVEYOR_BUILD_FOLDER%\install_zip\

    7z a ETA_Install-win64.zip %APPVEYOR_BUILD_FOLDER%\install_zip\*.*

    7z a ETA_Backend-win64.zip %APPVEYOR_BUILD_FOLDER%\install_zip\*.whl

test_script:
- cmd: >-
    gothub upload -u timetag -r ETA -t "%ETA_VER%" -f "ETA_LIB-win64.zip"  -n "ETA_LIB-win64.zip" --replace
     
    gothub upload -u timetag -r ETA -t "%ETA_VER%" -f "ETA_Install-win64.zip"  -n "ETA_Install-win64.zip" --replace
    
    gothub upload -u timetag -r ETA -t "%ETA_VER%" -f "ETA_Backend-win64.zip"  -n "ETA_Backend-win64.zip" --replace

    echo twine upload %APPVEYOR_BUILD_FOLDER%\dist\*.whl -u %PYPI_USERNAME% -p %PYPI_PASSWORD% --skip-existing
    
